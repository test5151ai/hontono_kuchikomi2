<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:3000 http://localhost:8080; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com http://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com http://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:;">
    <title>スレッド - 15ch.net</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- カスタムCSS -->
    <link href="/css/style.css" rel="stylesheet">
    <style>
        /* ページ固有のスタイル修正 */
        body {
            background-color: var(--light-gray);
        }
        
        main {
            margin-top: 2rem;
            margin-bottom: 2rem;
            min-height: 70vh;
        }
        
        /* スレッド詳細エリア */
        .thread-detail {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        /* カードスタイルリセット */
        .card {
            height: auto !important;
        }
        
        .card-body {
            height: auto !important;
        }
        
        /* 投稿スタイル */
        .post {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: white;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .post-header {
            background-color: rgba(0, 0, 0, 0.02);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 引用スタイル */
        .quote-line {
            background-color: #f5f5f5;
            border-left: 3px solid #007bff;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            color: #555;
        }
        
        /* 投稿番号のスタイル */
        .post-number {
            display: inline-block;
            background-color: #e9f7fe;
            color: #0056b3;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        /* アンカーリンクのスタイル */
        .post-anchor, .post-anchor-range {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        
        .post-anchor:hover, .post-anchor-range:hover {
            text-decoration: underline;
            color: #0056b3;
        }
        
        /* ポップアッププレビューのスタイル */
        .anchor-preview {
            position: absolute;
            z-index: 1000;
            width: 300px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0.5rem;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        .anchor-preview.show {
            opacity: 1;
        }
        
        .thread-detail, .post-form.card {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .thread-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .post-author {
            font-weight: 300;
            color: #2e8b57;
            font-size: 0.75rem;
            background-color: transparent;
            padding: 0;
        }

        .post-content {
            line-height: 1.4;
            margin-top: -4px;
            padding-top: 0;
            white-space: pre-line;
        }

        .helpful-button {
            font-size: 0.75rem;
            transition: all 0.2s ease;
            padding: 0.15rem 0.4rem;
            line-height: 1;
            color: #0056b3;
            border-color: #0056b3;
        }
        
        .helpful-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .helpful-button.btn-info {
            background-color: #0056b3;
            border-color: #0056b3;
            color: white;
        }
        
        .helpful-text {
            font-size: 0.75rem;
            font-weight: 300;
        }

        .helpful-count {
            margin-left: 0.25rem;
            font-weight: bold;
            font-size: 0.75rem;
        }
        
        .admin-actions {
            border-top: 1px solid #f0f0f0;
            padding-top: 0.75rem;
        }
        
        /* 投稿フォームカードのスタイル修正 */
        .post-form.card {
            height: auto;
        }
        
        .post-form .card-body {
            padding: 1rem;
        }
        
        .post-form .form-label {
            margin-bottom: 0.25rem;
        }
        
        .post-form .mb-3 {
            margin-bottom: 0.75rem;
        }
        
        .post-form .form-text {
            margin-top: 0.25rem;
            font-size: 0.75rem;
        }
        
        .post-form textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        /* サイドバーカードのスタイル修正 */
        .col-lg-3 .card {
            height: auto;
        }
        
        .col-lg-3 .card-header {
            padding: 0.75rem 1rem;
        }
        
        .col-lg-3 .list-group-item {
            padding: 0.6rem 1rem;
            border-left: none;
            border-right: none;
        }
        
        .col-lg-3 .list-group-item:first-child {
            border-top: none;
        }
        
        .col-lg-3 .list-group-item:last-child {
            border-bottom: none;
        }
        
        /* スケルトンローディングのスタイル */
        .skeleton-loading {
            height: auto;
        }
        
        .skeleton-line {
            height: 12px;
            margin-bottom: 8px;
            background: #eee;
            border-radius: 4px;
        }
        
        /* バッジのサイズ調整 */
        .badge.bg-light {
            font-size: 0.7rem;
            padding: 0.1rem 0.35rem;
        }

        .post-date {
            font-size: 0.7rem;
            color: #6c757d;
        }

        .card-body {
            padding: 0.75rem 1rem;
        }
        
        .post-header {
            margin-bottom: 0;
        }
        
        .post-content {
            line-height: 1.4;
        }

        /* パンくずリストのスタイル */
        .breadcrumb {
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            padding: 0.4rem 0.75rem;
            background-color: #f8f9fa;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            color: #6c757d;
        }
        
        .breadcrumb-item a {
            color: #0056b3;
        }
        
        .breadcrumb-item.active {
            color: #495057;
        }

        .post-actions {
            margin-top: 0.75rem;
        }

        /* 店舗情報のスタイル */
        .shop-details {
            font-size: 0.9rem;
            line-height: 1.5;
            border-left: 3px solid #2e8b57;
        }
        
        .shop-url {
            font-size: 0.85rem;
        }
        
        .shop-description {
            white-space: pre-line;
        }

        /* 投稿のハイライト */
        .post.highlighted {
            border-left: 4px solid #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
            transition: background-color 0.5s ease-in-out;
        }

        .reply-button {
            font-size: 0.75rem;
            transition: all 0.2s ease;
            padding: 0.15rem 0.4rem;
            line-height: 1;
        }
        
        .reply-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <site-header></site-header>

    <main class="container py-4">
        <div class="row">
            <div class="col-lg-8">
                <div class="thread-detail bg-white rounded shadow-sm p-3 mb-3">
                    <!-- パンくずリスト -->
                    <nav aria-label="breadcrumb" class="mb-2">
                        <ol class="breadcrumb bg-light p-2 rounded mb-0">
                            <li class="breadcrumb-item"><a href="/" class="text-decoration-none">ホーム</a></li>
                            <li class="breadcrumb-item" id="category-breadcrumb"><a href="#" class="text-decoration-none">カテゴリ</a></li>
                        </ol>
                    </nav>
                    
                    <div id="threadHeader" class="mb-4">
                        <!-- スレッドのヘッダー情報がここに動的に追加されます -->
                    </div>

                    <div id="posts" class="posts">
                        <!-- 投稿一覧がここに動的に追加されます -->
                    </div>
                </div>

                <div class="post-form card mt-3 shadow-sm">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                        <h3 class="card-title h5 mb-0">新規投稿</h3>
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#replyHelpModal">
                            <i class="fas fa-question-circle me-1"></i>レスの仕方
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="postForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="content" class="form-label">投稿内容</label>
                                <textarea class="form-control" id="content" name="content" 
                                        required minlength="1" maxlength="2000" rows="3"
                                        placeholder="投稿内容を入力してください"></textarea>
                                <div class="invalid-feedback">
                                    投稿内容を入力してください。
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="authorName" class="form-label">投稿者名（任意）</label>
                                <input type="text" class="form-control" id="authorName" name="authorName"
                                       maxlength="30" placeholder="匿名の場合は空欄にしてください">
                                <div class="form-text">
                                    空欄の場合は「名無しさん」として投稿されます。
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>投稿する
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <site-sidebar></site-sidebar>
            </div>
        </div>
    </main>

    <!-- スレッド編集モーダル (管理者用) -->
    <div class="modal fade" id="editThreadModal" tabindex="-1" aria-labelledby="editThreadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editThreadModalLabel">スレッド編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="threadModalAlerts"></div>
                    <form id="editThreadForm">
                        <div class="mb-3">
                            <label for="editThreadTitle" class="form-label">タイトル</label>
                            <input type="text" class="form-control" id="editThreadTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editThreadCategory" class="form-label">カテゴリー</label>
                            <select class="form-select" id="editThreadCategory" required>
                                <!-- カテゴリー一覧がここに動的に追加されます -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" id="saveThreadBtn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 投稿編集モーダル (管理者用) -->
    <div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPostModalLabel">投稿編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="postModalAlerts"></div>
                    <form id="editPostForm">
                        <input type="hidden" id="editPostId">
                        <div class="mb-3">
                            <label for="editPostContent" class="form-label">投稿内容</label>
                            <textarea class="form-control" id="editPostContent" required rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editPostAuthor" class="form-label">投稿者名</label>
                            <input type="text" class="form-control" id="editPostAuthor">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" id="savePostBtn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 店舗情報編集モーダル -->
    <div class="modal fade" id="editShopDetailsModal" tabindex="-1" aria-labelledby="editShopDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editShopDetailsModalLabel">店舗情報編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="shopDetailsModalAlerts"></div>
                    <form id="editShopDetailsForm">
                        <div class="mb-3">
                            <label for="shopUrl" class="form-label">店舗URL</label>
                            <input type="url" class="form-control" id="shopUrl" placeholder="https://example.com">
                            <div class="form-text">店舗のウェブサイトやSNSのURLを入力してください</div>
                        </div>
                        <div class="mb-3">
                            <label for="shopDetails" class="form-label">店舗詳細情報</label>
                            <textarea class="form-control" id="shopDetails" rows="5" placeholder="営業時間、アクセス方法、メニュー情報など"></textarea>
                            <div class="form-text">店舗に関する詳細情報を入力してください</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" id="saveShopDetailsBtn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- レスの仕方説明モーダル -->
    <div class="modal fade" id="replyHelpModal" tabindex="-1" aria-labelledby="replyHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="replyHelpModalLabel">レスの仕方ガイド</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="card-title mb-0">アンカー機能の使い方</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>特定の投稿を参照する：</strong></p>
                                    <div class="bg-light p-2 mb-3 border">
                                        <code>>>1</code> → 1番の投稿を参照
                                    </div>
                                    
                                    <p><strong>複数の投稿を参照する：</strong></p>
                                    <div class="bg-light p-2 mb-3 border">
                                        <code>>>1-3</code> → 1〜3番の投稿を参照
                                    </div>
                                    
                                    <p><strong>使用例：</strong></p>
                                    <div class="bg-light p-2 border">
                                        >>1 の言っていることに賛成です。<br>
                                        >>2-3 は同じ内容を言っていますね。
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">基本的な書き方</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>引用の書き方：</strong></p>
                                    <div class="bg-light p-2 mb-3 border">
                                        <code>></code> で始まる行は引用になります<br>
                                        <code>> これは引用文です</code>
                                    </div>
                                    
                                    <p><strong>URLの書き方：</strong></p>
                                    <div class="bg-light p-2 mb-3 border">
                                        URLをそのまま書くと自動的にリンクになります<br>
                                        <code>https://example.com</code>
                                    </div>
                                    
                                    <p><strong>改行について：</strong></p>
                                    <div class="bg-light p-2 border">
                                        改行はそのまま反映されます
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-2">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">便利なTips</h5>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li>投稿番号（レス番）は、各投稿の左上に表示されています</li>
                                <li>アンカーリンクをクリックすると、該当の投稿へジャンプします</li>
                                <li>特定の投稿に返信したい場合は、その投稿の<span class="badge bg-secondary">返信</span>ボタンをクリックすると、引用付きで返信できます</li>
                                <li>引用されたテキストは編集可能です。必要な部分だけを残して引用することができます</li>
                                <li>長文を書く場合は、適宜改行を入れると読みやすくなります</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <site-footer></site-footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- コンポーネント -->
    <script src="/js/components/header.js"></script>
    <script src="/js/components/footer.js"></script>
    <script src="/js/components/sidebar.js"></script>
    <!-- メインスクリプト -->
    <script>
        // URLパラメータからスレッドIDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const threadId = urlParams.get('id');
        
        // 投稿を取得して表示
        async function loadPosts() {
            try {
                showLoading(true);
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/posts?page=1&limit=100`);
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('投稿データ受信:', data);
                
                // APIからのレスポンス形式を確認（バックエンドの変更に対応）
                const posts = data.posts || data || [];
                
                if (!posts || posts.length === 0) {
                    document.getElementById('posts').innerHTML = '<p class="text-center p-4">投稿がありません。</p>';
                    showLoading(false);
                    return;
                }
                
                // 投稿番号を確認（デバッグ用）
                console.log('投稿番号確認:');
                posts.forEach((post, index) => {
                    console.log(`投稿インデックス ${index}, ID: ${post.id}, 投稿番号: ${post.postNumber}`);
                });
                
                const postsContainer = document.getElementById('posts');
                
                const postsHtml = posts.map((post, index) => {
                    return `
                        <div class="post card mb-3 shadow-sm" id="post-${post.id}" data-post-number="${post.postNumber}">
                            <div class="card-body">
                                <div class="post-header d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="post-number">${post.postNumber}</span>
                                        <span class="post-author">${post.authorName || '名無しさん'}</span>
                                    </div>
                                    <div class="post-date">
                                        ${formatDateFull(post.createdAt)}
                                    </div>
                                </div>
                                <div class="post-content">
                                    ${formatContent(post.content)}
                                </div>
                                <div class="post-actions d-flex justify-content-between align-items-center">
                                    <div>
                                        <button class="helpful-button btn btn-outline-info me-2" data-post-id="${post.id}">
                                            <i class="far fa-thumbs-up me-1"></i>
                                            <span class="helpful-text">参考になった</span>
                                            <span class="helpful-count">${post.helpfulCount || 0}</span>
                                        </button>
                                        <button class="reply-button btn btn-outline-secondary" data-post-number="${post.postNumber}">
                                            <i class="fas fa-reply me-1"></i>返信
                                        </button>
                                    </div>
                                    <div id="admin-actions-${post.id}" class="admin-actions d-none">
                                        <button class="btn btn-sm btn-outline-danger delete-button" data-post-id="${post.id}">
                                            <i class="far fa-trash-alt"></i> 削除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                postsContainer.innerHTML = postsHtml;
                
                // 管理者ボタンを表示（管理者の場合のみ）
                checkAdminStatus();
                
                // 参考になったボタンのイベントリスナーを設定
                document.querySelectorAll('.helpful-button').forEach(button => {
                    button.addEventListener('click', markHelpful);
                });
                
                // 削除ボタンのイベントリスナーを設定
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', deletePost);
                });
                
                // 返信ボタンのイベントリスナーを設定
                document.querySelectorAll('.reply-button').forEach(button => {
                    button.addEventListener('click', addQuoteReply);
                });
                
                // アンカーリンクのクリックイベントを設定
                setupAnchorLinks();
                
                showLoading(false);
            } catch (error) {
                console.error('投稿の取得に失敗しました:', error);
                document.getElementById('posts').innerHTML = `
                    <div class="alert alert-danger">
                        投稿の取得に失敗しました。
                        <br>
                        <small class="d-block mt-2">${error.message}</small>
                    </div>
                `;
                showLoading(false);
            }
        }
        
        // スレッド情報を取得して表示
        async function loadThread() {
            try {
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}`);
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const thread = await response.json();
                
                // パンくずリストを更新
                updateBreadcrumb(thread);
                
                const threadHeader = document.getElementById('threadHeader');
                const formattedDate = formatDate(thread.createdAt);
                
                threadHeader.innerHTML = `
                    <h1 class="thread-title mb-2">${thread.title}</h1>
                    <div class="thread-meta d-flex flex-wrap align-items-center text-muted mb-3">
                        <span class="me-3">
                            <i class="far fa-folder me-1"></i>
                            <a href="/category.html?id=${thread.categoryId}" class="text-decoration-none">
                                ${thread.category ? thread.category.name : '不明'}
                            </a>
                        </span>
                        <span class="me-3"><i class="far fa-clock me-1"></i>${formattedDate}</span>
                        <span class="badge rounded-pill bg-secondary" id="post-count-badge">
                            <i class="spinner-border spinner-border-sm"></i>
                        </span>
                    </div>
                    ${thread.shopDetails ? `
                    <div class="shop-details p-3 bg-light rounded mb-3">
                        ${thread.shopUrl ? `
                        <div class="shop-url mb-2">
                            <i class="fas fa-link me-2"></i>
                            <a href="${thread.shopUrl}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                ${thread.shopUrl}
                            </a>
                        </div>
                        ` : ''}
                        <div class="shop-description">
                            ${formatContent(thread.shopDetails)}
                        </div>
                    </div>
                    ` : ''}
                    <div id="admin-thread-actions" class="mb-3 d-none">
                        <button id="edit-thread-btn" class="btn btn-sm btn-outline-primary">
                            <i class="far fa-edit"></i> スレッド編集
                        </button>
                        <button id="edit-shop-details-btn" class="btn btn-sm btn-outline-info">
                            <i class="far fa-edit"></i> 店舗情報編集
                        </button>
                        <button id="delete-thread-btn" class="btn btn-sm btn-outline-danger">
                            <i class="far fa-trash-alt"></i> スレッド削除
                        </button>
                    </div>
                `;
                
                // タイトルを更新
                document.title = `${thread.title} - 15ch.net`;
                
                // 投稿数を取得して表示
                updatePostCount();
                
                // 管理者ボタンを表示（管理者の場合のみ）
                checkAdminStatus();
                
                // スレッド編集ボタンのイベントリスナーを設定
                const editThreadBtn = document.getElementById('edit-thread-btn');
                if (editThreadBtn) {
                    editThreadBtn.addEventListener('click', () => {
                        window.location.href = `/admin/edit-thread.html?id=${threadId}`;
                    });
                }
                
                // スレッド削除ボタンのイベントリスナーを設定
                const deleteThreadBtn = document.getElementById('delete-thread-btn');
                if (deleteThreadBtn) {
                    deleteThreadBtn.addEventListener('click', deleteThread);
                }
                
                // 店舗情報編集ボタンのイベントリスナーを設定
                const editShopDetailsBtn = document.getElementById('edit-shop-details-btn');
                if (editShopDetailsBtn) {
                    editShopDetailsBtn.addEventListener('click', () => {
                        // モーダルを表示する前に既存のデータを設定
                        document.getElementById('shopUrl').value = thread.shopUrl || '';
                        document.getElementById('shopDetails').value = thread.shopDetails || '';
                        
                        // モーダルを表示
                        const modal = new bootstrap.Modal(document.getElementById('editShopDetailsModal'));
                        modal.show();
                    });
                }
                
                // 店舗情報保存ボタンのイベントリスナーを設定
                const saveShopDetailsBtn = document.getElementById('saveShopDetailsBtn');
                if (saveShopDetailsBtn) {
                    saveShopDetailsBtn.addEventListener('click', updateShopDetails);
                }
            } catch (error) {
                console.error('スレッド情報の取得に失敗しました:', error);
                const threadHeader = document.getElementById('threadHeader');
                threadHeader.innerHTML = `
                    <div class="alert alert-danger">
                        スレッド情報の取得に失敗しました。
                        <br>
                        <small class="d-block mt-2">${error.message}</small>
                    </div>
                `;
            }
        }
        
        // パンくずリストを更新
        function updateBreadcrumb(thread) {
            // カテゴリリンクを更新
            const categoryBreadcrumb = document.getElementById('category-breadcrumb');
            if (categoryBreadcrumb && thread.category) {
                const categoryLink = categoryBreadcrumb.querySelector('a');
                categoryLink.href = `/category.html?id=${thread.categoryId}`;
                categoryLink.textContent = thread.category.name;
            }
        }
        
        // ローディング表示の切り替え
        function showLoading(show) {
            const postsContainer = document.getElementById('posts');
            if (show) {
                postsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">投稿を読み込み中...</p>
                    </div>
                `;
            }
        }
        
        // 投稿数を更新
        async function updatePostCount() {
            try {
                // APIエンドポイントの変更: posts/countではなく直接投稿をカウント
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/posts`);
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('投稿数データ受信:', data);
                
                const postCountBadge = document.getElementById('post-count-badge');
                if (postCountBadge) {
                    // APIからのレスポンス形式を確認（バックエンドの変更に対応）
                    const posts = data.posts || data || [];
                    const count = posts.length;
                    postCountBadge.innerHTML = `<i class="far fa-comment me-1"></i>${count}件`;
                }
            } catch (error) {
                console.error('投稿数の取得に失敗しました:', error);
                const postCountBadge = document.getElementById('post-count-badge');
                if (postCountBadge) {
                    postCountBadge.innerHTML = `<i class="far fa-comment me-1"></i>-件`;
                }
            }
        }
        
        // 管理者権限チェック
        async function checkAdminStatus() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return;
                }
                
                // APIエンドポイントの変更: check-adminではなくcheckに変更
                const response = await fetch('http://localhost:3000/api/auth/check', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // 管理者または特権ユーザーの場合のみ表示
                    if (data.isAdmin || data.isSuperuser) {
                        // 管理者用ボタンを表示
                        const adminThreadActions = document.getElementById('admin-thread-actions');
                        if (adminThreadActions) {
                            adminThreadActions.classList.remove('d-none');
                        }
                        
                        // 各投稿の管理者用ボタンを表示
                        document.querySelectorAll('[id^="admin-actions-"]').forEach(element => {
                            element.classList.remove('d-none');
                        });
                    }
                }
            } catch (error) {
                console.error('管理者権限のチェックに失敗しました:', error);
            }
        }
        
        // 参考になったボタンのイベントハンドラ
        async function markHelpful(event) {
            const button = event.currentTarget;
            const postId = button.getAttribute('data-post-id');
            
            try {
                const response = await fetch(`http://localhost:3000/api/posts/${postId}/helpful`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                const countElement = button.querySelector('.helpful-count');
                countElement.textContent = data.helpfulCount;
                
                // クリック後のスタイル変更
                button.classList.remove('btn-outline-info');
                button.classList.add('btn-info');
                button.innerHTML = `<i class="fas fa-thumbs-up me-1"></i> <span class="helpful-text">参考になった</span> <span class="helpful-count badge rounded-pill bg-light text-dark">${data.helpfulCount}</span>`;
                button.disabled = true;
                
                // LocalStorageに記録
                const helpfulPosts = JSON.parse(localStorage.getItem('helpfulPosts') || '[]');
                if (!helpfulPosts.includes(postId)) {
                    helpfulPosts.push(postId);
                    localStorage.setItem('helpfulPosts', JSON.stringify(helpfulPosts));
                }
            } catch (error) {
                console.error('参考になった登録に失敗しました:', error);
                alert('参考になった登録に失敗しました。');
            }
        }
        
        // 投稿削除のイベントハンドラ
        async function deletePost(event) {
            const button = event.currentTarget;
            const postId = button.getAttribute('data-post-id');
            
            if (!confirm('本当にこの投稿を削除しますか？')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('管理者権限が必要です。');
                    return;
                }
                
                const response = await fetch(`http://localhost:3000/api/posts/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const postElement = document.getElementById(`post-${postId}`);
                    if (postElement) {
                        postElement.innerHTML = '<div class="card-body text-muted text-center">[この投稿は削除されました]</div>';
                    }
                    
                    // 投稿数を更新
                    updatePostCount();
                } else {
                    const data = await response.json();
                    alert(`削除に失敗しました: ${data.message || 'エラーが発生しました'}`);
                }
            } catch (error) {
                console.error('投稿の削除に失敗しました:', error);
                alert('投稿の削除に失敗しました。');
            }
        }
        
        // スレッド削除のイベントハンドラ
        async function deleteThread() {
            if (!confirm('本当にこのスレッドを削除しますか？すべての投稿も削除されます。')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('管理者権限が必要です。');
                    return;
                }
                
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('スレッドが削除されました。');
                    window.location.href = '/';
                } else {
                    const data = await response.json();
                    alert(`削除に失敗しました: ${data.message || 'エラーが発生しました'}`);
                }
            } catch (error) {
                console.error('スレッドの削除に失敗しました:', error);
                alert('スレッドの削除に失敗しました。');
            }
        }
        
        // 新規投稿フォームの送信ハンドラ
        document.getElementById('postForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // フォームのバリデーション
            const form = event.target;
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // フォームデータの取得
            const content = document.getElementById('content').value;
            const authorName = document.getElementById('authorName').value || '名無しさん';
            
            // 送信中の表示
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 送信中...';
            
            try {
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content, authorName })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // スレッド上限に達して新しいスレッドが作成された場合のリダイレクト処理
                    if (data.redirectTo) {
                        // 新しいスレッドが作成されたことを通知
                        alert(data.message || '投稿数上限に達したため、新しいスレッドを作成しました。新しいスレッドに移動します。');
                        
                        // 新しいスレッドにリダイレクト
                        window.location.href = data.redirectTo;
                        return;
                    }
                    
                    // 通常の投稿成功処理
                    // フォームをリセット
                    form.reset();
                    form.classList.remove('was-validated');
                    
                    // 投稿一覧を再読み込み
                    loadPosts();
                    
                    // 投稿数を更新
                    updatePostCount();
                    
                    // 一番下にスクロール
                    window.scrollTo(0, document.body.scrollHeight);
                } else {
                    const data = await response.json();
                    alert(`投稿に失敗しました: ${data.message || 'エラーが発生しました'}`);
                }
            } catch (error) {
                console.error('投稿の送信に失敗しました:', error);
                alert('投稿の送信に失敗しました。');
            } finally {
                // ボタンを元に戻す
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // HTMLエスケープ関数
        function escapeHTML(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 投稿内容のフォーマット
        function formatContent(content) {
            if (!content) return '';
            
            // HTMLエスケープ
            let escapedContent = escapeHTML(content);
            
            // 改行を保持
            escapedContent = escapedContent.replace(/\n/g, '<br>');
            
            // 引用部分をスタイリング（> で始まる行）
            escapedContent = escapedContent.replace(/^&gt;(.*)(<br>|$)/gm, '<div class="quote-line">&gt;$1</div>');
            
            // アンカー（>>数字）とアンカー範囲（>>数字-数字）をリンクに変換
            // 1. 範囲指定のアンカー（>>1-3）
            escapedContent = escapedContent.replace(/&gt;&gt;(\d+)-(\d+)/g, (match, start, end) => {
                return `<a href="#" class="post-anchor-range" data-start="${start}" data-end="${end}">${match}</a>`;
            });
            
            // 2. 単一のアンカー（>>1）
            escapedContent = escapedContent.replace(/&gt;&gt;(\d+)(?!-\d+)/g, (match, postNumber) => {
                return `<a href="#" class="post-anchor" data-post-number="${postNumber}">${match}</a>`;
            });
            
            // URLをリンクに変換
            const urlRegex = /(https?:\/\/[^\s<]+)/g;
            escapedContent = escapedContent.replace(urlRegex, url => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
            
            return escapedContent;
        }
        
        // 日付のフォーマット（相対時間）
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'たった今';
            } else if (diffInSeconds < 3600) {
                return `${Math.floor(diffInSeconds / 60)}分前`;
            } else if (diffInSeconds < 86400) {
                return `${Math.floor(diffInSeconds / 3600)}時間前`;
            } else if (diffInSeconds < 604800) {
                return `${Math.floor(diffInSeconds / 86400)}日前`;
            } else {
                return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            }
        }
        
        // 日付のフォーマット（完全な日時）
        function formatDateFull(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${year}年${month}月${day}日 ${hours}:${minutes}`;
        }
        
        // 店舗情報を更新する関数
        async function updateShopDetails() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('ログインが必要です');
                    return;
                }
                
                const shopUrl = document.getElementById('shopUrl').value.trim();
                const shopDetails = document.getElementById('shopDetails').value.trim();
                
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/shop-details`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ shopUrl, shopDetails })
                });
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editShopDetailsModal'));
                modal.hide();
                
                // 成功メッセージを表示
                alert('店舗情報が更新されました');
                
                // 画面を更新
                loadThread();
                
            } catch (error) {
                console.error('店舗情報の更新に失敗しました:', error);
                const alertsContainer = document.getElementById('shopDetailsModalAlerts');
                alertsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        店舗情報の更新に失敗しました。
                        <br>
                        <small class="d-block mt-2">${error.message}</small>
                    </div>
                `;
            }
        }
        
        // アンカーリンクのセットアップ
        function setupAnchorLinks() {
            // プレビュー表示用の要素
            const previewEl = document.createElement('div');
            previewEl.className = 'anchor-preview';
            document.body.appendChild(previewEl);
            
            // 単一アンカーのクリックイベント
            document.querySelectorAll('.post-anchor').forEach(anchor => {
                // クリックで対象投稿へジャンプ
                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    const postNumber = anchor.getAttribute('data-post-number');
                    jumpToPost(postNumber);
                });
                
                // ホバーでプレビュー表示
                anchor.addEventListener('mouseenter', (e) => {
                    const postNumber = anchor.getAttribute('data-post-number');
                    showPostPreview(anchor, postNumber);
                });
                
                anchor.addEventListener('mouseleave', () => {
                    hidePostPreview();
                });
            });
            
            // 範囲アンカーのクリックイベント
            document.querySelectorAll('.post-anchor-range').forEach(anchor => {
                anchor.addEventListener('click', (e) => {
                    e.preventDefault();
                    const start = parseInt(anchor.getAttribute('data-start'));
                    const end = parseInt(anchor.getAttribute('data-end'));
                    
                    // 範囲の最初の投稿へジャンプ
                    jumpToPost(start);
                });
                
                // ホバーでプレビュー表示（先頭の投稿のみ）
                anchor.addEventListener('mouseenter', (e) => {
                    const start = anchor.getAttribute('data-start');
                    showPostPreview(anchor, start, true);
                });
                
                anchor.addEventListener('mouseleave', () => {
                    hidePostPreview();
                });
            });
        }
        
        // 投稿へのジャンプ
        function jumpToPost(postNumber) {
            const posts = document.querySelectorAll('.post');
            let targetPost = null;
            
            for (const post of posts) {
                if (post.getAttribute('data-post-number') === postNumber) {
                    targetPost = post;
                    break;
                }
            }
            
            if (targetPost) {
                // 以前にハイライトされた投稿があれば解除
                document.querySelectorAll('.post.highlighted').forEach(p => {
                    p.classList.remove('highlighted');
                });
                
                // 対象の投稿をハイライト
                targetPost.classList.add('highlighted');
                
                // 対象の投稿へスクロール
                targetPost.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // 一定時間後にハイライトを解除
                setTimeout(() => {
                    targetPost.classList.remove('highlighted');
                }, 3000);
            }
        }
        
        // 投稿プレビューの表示
        function showPostPreview(anchorEl, postNumber, isRange = false) {
            const posts = document.querySelectorAll('.post');
            let targetPost = null;
            
            for (const post of posts) {
                if (post.getAttribute('data-post-number') === postNumber) {
                    targetPost = post;
                    break;
                }
            }
            
            if (targetPost) {
                const previewEl = document.querySelector('.anchor-preview');
                let content = targetPost.querySelector('.post-content').innerHTML;
                
                // 長すぎる内容は省略
                if (content.length > 200) {
                    content = content.substring(0, 200) + '...';
                }
                
                // プレビュー内容を設定
                previewEl.innerHTML = `
                    <div class="preview-header mb-1">
                        <strong>${postNumber}:</strong> 
                        <span class="preview-author">${targetPost.querySelector('.post-author').textContent}</span>
                    </div>
                    <div class="preview-content small">
                        ${content}
                    </div>
                    ${isRange ? '<div class="text-end small text-muted mt-1">※範囲の先頭の投稿のみ表示</div>' : ''}
                `;
                
                // アンカー要素の位置を基準にプレビューを配置
                const rect = anchorEl.getBoundingClientRect();
                const scrollY = window.scrollY || window.pageYOffset;
                
                // 画面下部の場合は上に表示
                if (rect.bottom + 320 > window.innerHeight) {
                    previewEl.style.top = (rect.top + scrollY - 10 - previewEl.offsetHeight) + 'px';
                } else {
                    previewEl.style.top = (rect.bottom + scrollY + 10) + 'px';
                }
                
                // 画面右端の場合は左に表示
                if (rect.right + 320 > window.innerWidth) {
                    previewEl.style.left = (rect.left - 250) + 'px';
                } else {
                    previewEl.style.left = rect.left + 'px';
                }
                
                // プレビューを表示
                previewEl.classList.add('show');
            }
        }
        
        // 投稿プレビューの非表示
        function hidePostPreview() {
            const previewEl = document.querySelector('.anchor-preview');
            previewEl.classList.remove('show');
        }
        
        // 引用返信機能
        function addQuoteReply(event) {
            const button = event.currentTarget;
            const postNumber = button.getAttribute('data-post-number');
            const postElement = document.querySelector(`.post[data-post-number="${postNumber}"]`);
            
            if (postElement) {
                const contentElement = postElement.querySelector('.post-content');
                const authorElement = postElement.querySelector('.post-author');
                
                let content = contentElement.textContent || '';
                const author = authorElement.textContent || '名無しさん';
                
                // 内容が長すぎる場合は省略
                if (content.length > 200) {
                    content = content.substring(0, 200) + '...';
                }
                
                // 引用形式にフォーマット（各行の先頭に > を追加）
                const quotedText = content
                    .split('\n')
                    .map(line => `> ${line}`)
                    .join('\n');
                
                // テキストエリアに引用を挿入
                const textarea = document.getElementById('content');
                let newContent = '';
                
                // すでに内容がある場合は、その後に追加
                if (textarea.value) {
                    newContent = `${textarea.value}\n\n>>${postNumber}\n${quotedText}\n\n`;
                } else {
                    newContent = `>>${postNumber}\n${quotedText}\n\n`;
                }
                
                textarea.value = newContent;
                
                // テキストエリアにフォーカス
                textarea.focus();
                
                // 新しい内容の最後にカーソルを移動
                textarea.setSelectionRange(newContent.length, newContent.length);
                
                // 投稿フォームまでスクロール
                document.querySelector('.post-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // ページ読み込み時に実行
        document.addEventListener('DOMContentLoaded', () => {
            loadThread();
            loadPosts();
        });
    </script>
</body>
</html> 
