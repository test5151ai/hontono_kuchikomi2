<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http://localhost:3000 http://localhost:8080; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:;">
    <title>スレッド詳細 - 15ch.net</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- カスタムCSS -->
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- ヘッダー -->
    <site-header></site-header>

    <main class="container py-4">
        <div class="row">
            <div class="col-lg-9">
                <div class="thread-detail bg-white rounded shadow-sm p-3 mb-3">
                    <div id="threadHeader" class="mb-4">
                        <!-- スレッドのヘッダー情報がここに動的に追加されます -->
                    </div>

                    <div id="posts" class="posts">
                        <!-- 投稿一覧がここに動的に追加されます -->
                    </div>
                </div>

                <div class="post-form card mt-3 shadow-sm">
                    <div class="card-header bg-white py-2">
                        <h3 class="card-title h5 mb-0">新規投稿</h3>
                    </div>
                    <div class="card-body">
                        <form id="postForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="content" class="form-label">投稿内容</label>
                                <textarea class="form-control" id="content" name="content" 
                                        required minlength="1" maxlength="2000" rows="3"
                                        placeholder="投稿内容を入力してください"></textarea>
                                <div class="invalid-feedback">
                                    投稿内容を入力してください。
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="authorName" class="form-label">投稿者名（任意）</label>
                                <input type="text" class="form-control" id="authorName" name="authorName"
                                       maxlength="30" placeholder="匿名の場合は空欄にしてください">
                                <div class="form-text">
                                    空欄の場合は「名無しさん」として投稿されます。
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>投稿する
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3">
                <popular-threads-sidebar></popular-threads-sidebar>
            </div>
        </div>
    </main>

    <!-- スレッド編集モーダル (管理者用) -->
    <div class="modal fade" id="editThreadModal" tabindex="-1" aria-labelledby="editThreadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editThreadModalLabel">スレッド編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="threadModalAlerts"></div>
                    <form id="editThreadForm">
                        <div class="mb-3">
                            <label for="editThreadTitle" class="form-label">タイトル</label>
                            <input type="text" class="form-control" id="editThreadTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editThreadCategory" class="form-label">カテゴリー</label>
                            <select class="form-select" id="editThreadCategory" required>
                                <!-- カテゴリー一覧がここに動的に追加されます -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" id="saveThreadBtn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 投稿編集モーダル (管理者用) -->
    <div class="modal fade" id="editPostModal" tabindex="-1" aria-labelledby="editPostModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPostModalLabel">投稿編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="postModalAlerts"></div>
                    <form id="editPostForm">
                        <input type="hidden" id="editPostId">
                        <div class="mb-3">
                            <label for="editPostContent" class="form-label">投稿内容</label>
                            <textarea class="form-control" id="editPostContent" required rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editPostAuthor" class="form-label">投稿者名</label>
                            <input type="text" class="form-control" id="editPostAuthor">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" id="savePostBtn" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- コンポーネント -->
    <script src="/js/components/header.js"></script>
    <script src="/js/components/sidebar.js"></script>
    <!-- メインスクリプト -->
    <script>
        // URLパラメータからスレッドIDを取得
        const urlParams = new URLSearchParams(window.location.search);
        const threadId = urlParams.get('id');
        
        // 投稿を取得して表示
        async function loadPosts() {
            try {
                showLoading(true);
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/posts?page=1&limit=100`);
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('投稿データ受信:', data);
                
                // APIからのレスポンス形式を確認（バックエンドの変更に対応）
                const posts = data.posts || data || [];
                
                if (!posts || posts.length === 0) {
                    document.getElementById('posts').innerHTML = '<p class="text-center p-4">投稿がありません。</p>';
                    showLoading(false);
                    return;
                }
                
                const postsContainer = document.getElementById('posts');
                
                const postsHtml = posts.map((post, index) => {
                    return `
                        <div class="post card mb-3 shadow-sm" id="post-${post.id}">
                            <div class="card-body">
                                <div class="post-header d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <span class="post-number">#${index + 1}</span>
                                        <span class="post-author">${post.authorName || '名無しさん'}</span>
                                    </div>
                                    <div class="post-date text-muted small">
                                        ${formatDate(post.createdAt)}
                                    </div>
                                </div>
                                <div class="post-content mb-3">
                                    ${formatContent(post.content)}
                                </div>
                                <div class="post-actions d-flex justify-content-between align-items-center">
                                    <button class="helpful-button btn btn-sm btn-outline-secondary" data-post-id="${post.id}">
                                        <i class="far fa-thumbs-up"></i>
                                        参考になった
                                        <span class="helpful-count">${post.helpfulCount || 0}</span>
                                    </button>
                                    <div id="admin-actions-${post.id}" class="admin-actions d-none">
                                        <button class="btn btn-sm btn-outline-danger delete-button" data-post-id="${post.id}">
                                            <i class="far fa-trash-alt"></i> 削除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                postsContainer.innerHTML = postsHtml;
                
                // 管理者ボタンを表示（管理者の場合のみ）
                checkAdminStatus();
                
                // 参考になったボタンのイベントリスナーを設定
                document.querySelectorAll('.helpful-button').forEach(button => {
                    button.addEventListener('click', markHelpful);
                });
                
                // 削除ボタンのイベントリスナーを設定
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', deletePost);
                });
                
                showLoading(false);
            } catch (error) {
                console.error('投稿の取得に失敗しました:', error);
                document.getElementById('posts').innerHTML = `
                    <div class="alert alert-danger">
                        投稿の取得に失敗しました。
                        <br>
                        <small class="d-block mt-2">${error.message}</small>
                    </div>
                `;
                showLoading(false);
            }
        }
        
        // スレッド情報を取得して表示
        async function loadThread() {
            try {
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}`);
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const thread = await response.json();
                
                const threadHeader = document.getElementById('threadHeader');
                const formattedDate = formatDate(thread.createdAt);
                
                threadHeader.innerHTML = `
                    <h1 class="thread-title mb-2">${thread.title}</h1>
                    <div class="thread-meta d-flex flex-wrap align-items-center text-muted mb-3">
                        <span class="me-3">
                            <i class="far fa-folder me-1"></i>
                            <a href="/category.html?id=${thread.categoryId}" class="text-decoration-none">
                                ${thread.category ? thread.category.name : '不明'}
                            </a>
                        </span>
                        <span class="me-3"><i class="far fa-clock me-1"></i>${formattedDate}</span>
                        <span class="me-3"><i class="far fa-user me-1"></i>${thread.user ? thread.user.username : '不明'}</span>
                        <span class="badge rounded-pill bg-secondary" id="post-count-badge">
                            <i class="spinner-border spinner-border-sm"></i>
                        </span>
                    </div>
                    <div id="admin-thread-actions" class="mb-3 d-none">
                        <button id="edit-thread-btn" class="btn btn-sm btn-outline-primary">
                            <i class="far fa-edit"></i> スレッド編集
                        </button>
                        <button id="delete-thread-btn" class="btn btn-sm btn-outline-danger">
                            <i class="far fa-trash-alt"></i> スレッド削除
                        </button>
                    </div>
                `;
                
                // タイトルを更新
                document.title = `${thread.title} - 15ch.net`;
                
                // 投稿数を取得して表示
                updatePostCount();
                
                // 管理者ボタンを表示（管理者の場合のみ）
                checkAdminStatus();
                
                // スレッド編集ボタンのイベントリスナーを設定
                const editThreadBtn = document.getElementById('edit-thread-btn');
                if (editThreadBtn) {
                    editThreadBtn.addEventListener('click', () => {
                        window.location.href = `/admin/edit-thread.html?id=${threadId}`;
                    });
                }
                
                // スレッド削除ボタンのイベントリスナーを設定
                const deleteThreadBtn = document.getElementById('delete-thread-btn');
                if (deleteThreadBtn) {
                    deleteThreadBtn.addEventListener('click', deleteThread);
                }
            } catch (error) {
                console.error('スレッド情報の取得に失敗しました:', error);
                const threadHeader = document.getElementById('threadHeader');
                threadHeader.innerHTML = `
                    <div class="alert alert-danger">
                        スレッド情報の取得に失敗しました。
                        <br>
                        <small class="d-block mt-2">${error.message}</small>
                    </div>
                `;
            }
        }
        
        // ローディング表示の切り替え
        function showLoading(show) {
            const postsContainer = document.getElementById('posts');
            if (show) {
                postsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">投稿を読み込み中...</p>
                    </div>
                `;
            }
        }
        
        // 投稿数を更新
        async function updatePostCount() {
            try {
                // APIエンドポイントの変更: posts/countではなく直接投稿をカウント
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/posts`);
                
                if (!response.ok) {
                    throw new Error(`APIエラー: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('投稿数データ受信:', data);
                
                const postCountBadge = document.getElementById('post-count-badge');
                if (postCountBadge) {
                    // APIからのレスポンス形式を確認（バックエンドの変更に対応）
                    const posts = data.posts || data || [];
                    const count = posts.length;
                    postCountBadge.innerHTML = `<i class="far fa-comment me-1"></i>${count}件`;
                }
            } catch (error) {
                console.error('投稿数の取得に失敗しました:', error);
                const postCountBadge = document.getElementById('post-count-badge');
                if (postCountBadge) {
                    postCountBadge.innerHTML = `<i class="far fa-comment me-1"></i>-件`;
                }
            }
        }
        
        // 管理者権限チェック
        async function checkAdminStatus() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    return;
                }
                
                // APIエンドポイントの変更: check-adminではなくcheckに変更
                const response = await fetch('http://localhost:3000/api/auth/check', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // 管理者または特権ユーザーの場合のみ表示
                    if (data.isAdmin || data.isSuperuser) {
                        // 管理者用ボタンを表示
                        const adminThreadActions = document.getElementById('admin-thread-actions');
                        if (adminThreadActions) {
                            adminThreadActions.classList.remove('d-none');
                        }
                        
                        // 各投稿の管理者用ボタンを表示
                        document.querySelectorAll('[id^="admin-actions-"]').forEach(element => {
                            element.classList.remove('d-none');
                        });
                    }
                }
            } catch (error) {
                console.error('管理者権限のチェックに失敗しました:', error);
            }
        }
        
        // 参考になったボタンのイベントハンドラ
        async function markHelpful(event) {
            const button = event.currentTarget;
            const postId = button.getAttribute('data-post-id');
            
            try {
                const response = await fetch(`http://localhost:3000/api/posts/${postId}/helpful`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                const countElement = button.querySelector('.helpful-count');
                countElement.textContent = data.helpfulCount;
                
                // クリック後のスタイル変更
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-secondary');
                button.disabled = true;
                
                // LocalStorageに記録
                const helpfulPosts = JSON.parse(localStorage.getItem('helpfulPosts') || '[]');
                if (!helpfulPosts.includes(postId)) {
                    helpfulPosts.push(postId);
                    localStorage.setItem('helpfulPosts', JSON.stringify(helpfulPosts));
                }
            } catch (error) {
                console.error('参考になった登録に失敗しました:', error);
                alert('参考になった登録に失敗しました。');
            }
        }
        
        // 投稿削除のイベントハンドラ
        async function deletePost(event) {
            const button = event.currentTarget;
            const postId = button.getAttribute('data-post-id');
            
            if (!confirm('本当にこの投稿を削除しますか？')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('管理者権限が必要です。');
                    return;
                }
                
                const response = await fetch(`http://localhost:3000/api/posts/${postId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const postElement = document.getElementById(`post-${postId}`);
                    if (postElement) {
                        postElement.innerHTML = '<div class="card-body text-muted text-center">[この投稿は削除されました]</div>';
                    }
                    
                    // 投稿数を更新
                    updatePostCount();
                } else {
                    const data = await response.json();
                    alert(`削除に失敗しました: ${data.message || 'エラーが発生しました'}`);
                }
            } catch (error) {
                console.error('投稿の削除に失敗しました:', error);
                alert('投稿の削除に失敗しました。');
            }
        }
        
        // スレッド削除のイベントハンドラ
        async function deleteThread() {
            if (!confirm('本当にこのスレッドを削除しますか？すべての投稿も削除されます。')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('管理者権限が必要です。');
                    return;
                }
                
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('スレッドが削除されました。');
                    window.location.href = '/';
                } else {
                    const data = await response.json();
                    alert(`削除に失敗しました: ${data.message || 'エラーが発生しました'}`);
                }
            } catch (error) {
                console.error('スレッドの削除に失敗しました:', error);
                alert('スレッドの削除に失敗しました。');
            }
        }
        
        // 新規投稿フォームの送信ハンドラ
        document.getElementById('postForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // フォームのバリデーション
            const form = event.target;
            if (!form.checkValidity()) {
                event.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            
            // フォームデータの取得
            const content = document.getElementById('content').value;
            const authorName = document.getElementById('authorName').value || '名無しさん';
            
            // 送信中の表示
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 送信中...';
            
            try {
                const response = await fetch(`http://localhost:3000/api/threads/${threadId}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content, authorName })
                });
                
                if (response.ok) {
                    // フォームをリセット
                    form.reset();
                    form.classList.remove('was-validated');
                    
                    // 投稿一覧を再読み込み
                    loadPosts();
                    
                    // 投稿数を更新
                    updatePostCount();
                    
                    // 一番下にスクロール
                    window.scrollTo(0, document.body.scrollHeight);
                } else {
                    const data = await response.json();
                    alert(`投稿に失敗しました: ${data.message || 'エラーが発生しました'}`);
                }
            } catch (error) {
                console.error('投稿の送信に失敗しました:', error);
                alert('投稿の送信に失敗しました。');
            } finally {
                // ボタンを元に戻す
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        });
        
        // HTMLの特殊文字をエスケープする関数
        function escapeHTML(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        // 投稿内容のフォーマット
        function formatContent(content) {
            // HTMLエスケープ
            let escapedContent = escapeHTML(content);
            
            // URLをリンクに変換
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            escapedContent = escapedContent.replace(urlRegex, url => {
                return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
            });
            
            return escapedContent;
        }
        
        // 日付のフォーマット
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return 'たった今';
            } else if (diffInSeconds < 3600) {
                return `${Math.floor(diffInSeconds / 60)}分前`;
            } else if (diffInSeconds < 86400) {
                return `${Math.floor(diffInSeconds / 3600)}時間前`;
            } else if (diffInSeconds < 604800) {
                return `${Math.floor(diffInSeconds / 86400)}日前`;
            } else {
                return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            }
        }
        
        // ページ読み込み時に実行
        document.addEventListener('DOMContentLoaded', () => {
            loadThread();
            loadPosts();
        });
    </script>

    <style>
        body {
            background-color: #f5f8fa;
        }
        
        .thread-detail, .post-form.card {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .thread-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .post {
            background: #fff;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .post-number {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        .post-author {
            font-weight: 500;
        }

        .post-content {
            white-space: pre-line;
            line-height: 1.6;
        }

        .helpful-button {
            font-size: 0.875rem;
        }

        .helpful-count {
            margin-left: 0.5rem;
        }
        
        .admin-actions {
            border-top: 1px solid #f0f0f0;
            padding-top: 0.75rem;
        }
        
        /* 投稿フォームカードのスタイル修正 */
        .post-form.card {
            height: auto;
        }
        
        .post-form .card-body {
            padding: 1rem;
        }
        
        .post-form .form-label {
            margin-bottom: 0.25rem;
        }
        
        .post-form .mb-3 {
            margin-bottom: 0.75rem;
        }
        
        .post-form .form-text {
            margin-top: 0.25rem;
            font-size: 0.75rem;
        }
        
        .post-form textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        /* サイドバーカードのスタイル修正 */
        .col-lg-3 .card {
            height: auto;
        }
        
        .col-lg-3 .card-header {
            padding: 0.75rem 1rem;
        }
        
        .col-lg-3 .list-group-item {
            padding: 0.6rem 1rem;
            border-left: none;
            border-right: none;
        }
        
        .col-lg-3 .list-group-item:first-child {
            border-top: none;
        }
        
        .col-lg-3 .list-group-item:last-child {
            border-bottom: none;
        }
        
        /* スケルトンローディングのスタイル */
        .skeleton-loading {
            height: auto;
        }
        
        .skeleton-line {
            height: 12px;
            margin-bottom: 8px;
            background: #eee;
            border-radius: 4px;
        }
    </style>
</body>
</html> 
