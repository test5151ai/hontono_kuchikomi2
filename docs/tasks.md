# スレッドカテゴリー機能の実装タスク

## 1. データベース設計と実装
- [x] カテゴリーテーブルの作成
  - カラム: id, name, slug, description, createdAt, updatedAt
  - 初期カテゴリー:
    1. 銀行関連スレ
    2. 消費者金融スレ
    3. 街金スレ
    4. 個人融資スレ
    5. ファクタリングスレ
    6. 後払いスレ
    7. 闇金スレ
- [x] スレッドテーブルにカテゴリーIDを追加
- [x] マイグレーションファイルの作成
- [x] シードデータの作成

## 2. バックエンドAPI実装
- [x] カテゴリー関連のモデル作成
  - Categoryモデル
  - Threadモデル（カテゴリー関連）
- [x] カテゴリー関連のコントローラー作成
  - カテゴリー一覧取得
  - カテゴリー別スレッド一覧取得
  - カテゴリー詳細取得
- [x] ルーティングの設定
  - GET /api/categories
  - GET /api/categories/:id
  - GET /api/categories/:id/threads

## 3. フロントエンド実装
- [x] カテゴリー一覧ページの作成
  - カテゴリー一覧の表示
  - カテゴリーごとの説明
  - スレッド数の表示
- [x] カテゴリー別トップページの作成
  - カテゴリー名と説明の表示
  - スレッド一覧の表示
  - 新規スレッド作成ボタン
- [x] ナビゲーションの更新
  - カテゴリー一覧へのリンク追加
  - 現在のカテゴリー表示
- [ ] スレッド作成フォームの更新
  - カテゴリー選択機能の追加

## 4. テストとデバッグ
- [x] バックエンドAPIのテスト
  - カテゴリー一覧取得のテスト
  - カテゴリー別スレッド取得のテスト
- [x] フロントエンドのテスト
  - カテゴリー一覧ページの表示テスト
  - カテゴリー別ページの表示テスト
  - スレッド作成時のカテゴリー選択テスト

## 5. ドキュメント更新
- [x] APIドキュメントの更新
  - カテゴリー関連のエンドポイント追加
- [x] READMEの更新
  - カテゴリー機能の説明追加

## 6. デプロイ準備
- [x] マイグレーションの確認
- [x] シードデータの確認
- [x] 動作確認
  - カテゴリー一覧の表示
  - カテゴリー別ページの表示
  - スレッド作成時のカテゴリー選択 

# 管理機能の拡張タスク

## 1. ユーザー管理機能の拡張
### 検索・フィルタリング機能
- [ ] ユーザー検索機能の実装
  - メールアドレスでの検索
  - ユーザー名での検索
  - 登録日での絞り込み
- [ ] 検索結果の並び替え機能
  - 登録日順
  - ユーザー名順
  - ステータス順

### ユーザー管理機能の強化
- [ ] ユーザーの一時停止機能
  - 一時停止処理の実装
  - 一時停止解除処理の実装
  - 一時停止理由の記録
- [ ] ユーザー情報のエクスポート機能
  - CSV形式でのエクスポート
  - エクスポート項目の選択機能
- [ ] ユーザーアクティビティログ
  - ログイン履歴の記録
  - 投稿履歴の表示
  - アクション履歴の表示

## 2. カテゴリー管理機能の改善
### カテゴリー構造の拡張
- [ ] カテゴリーの並び順管理
  - 並び順の変更UI
  - 順序保存機能
- [ ] サブカテゴリー機能
  - 親子関係の実装
  - 階層表示UI
  - カテゴリーツリーの管理

### 統計・分析機能
- [ ] カテゴリー統計情報
  - 投稿数の集計
  - アクセス数の記録
  - 統計グラフの表示
- [ ] カテゴリーアーカイブ
  - アーカイブ処理の実装
  - アーカイブ一覧表示
  - 復元機能の実装

## 3. ダッシュボード機能の拡充
### リアルタイム情報
- [ ] アクセス統計の実装
  - 現在のアクティブユーザー数
  - 時間帯別アクセス数
  - ページビュー数
- [ ] システム状態の監視
  - サーバーステータス表示
  - DB接続状態表示
  - エラーログの表示

### コンテンツ分析
- [ ] 人気コンテンツランキング
  - スレッド別アクセス数
  - 投稿数の集計
  - ユーザー別投稿数
- [ ] 警告・報告管理
  - 報告された投稿の一覧
  - 対応状況の管理
  - 自動警告システム

## 4. スレッド管理機能
### 一括管理機能
- [ ] スレッドの一括操作
  - カテゴリー移動
  - 一括削除
  - 一括非表示
- [ ] スレッド制御機能
  - ピン留め機能
  - ロック（コメント停止）
  - 一時非表示

## 5. セキュリティ強化
### アクセス制御
- [ ] 管理者アクションログ
  - 操作ログの記録
  - ログ閲覧機能
  - アラート設定
- [ ] IPアクセス制限
  - ブラックリスト管理
  - アクセス制限ルール
  - 自動ブロック機能
- [ ] 2要素認証
  - 2FAの実装
  - バックアップコード
  - デバイス管理

## 6. バックアップ・リストア
### データ管理
- [ ] バックアップ機能
  - 定期バックアップ
  - 手動バックアップ
  - 世代管理
- [ ] リストア機能
  - バックアップからの復元
  - 部分リストア
  - リストア履歴

## 7. 通知機能
### 管理者通知
- [ ] イベント通知
  - 重要イベントの通知
  - 通知設定の管理
  - 通知履歴の表示
- [ ] メール通知
  - テンプレート管理
  - 一括送信機能
  - 送信履歴管理

## 8. レポート・分析
### データ分析
- [ ] カスタムレポート
  - レポート作成UI
  - データ集計機能
  - グラフ生成
- [ ] エクスポート機能
  - PDF出力
  - Excel出力
  - データ形式の選択

## 優先実装項目（第1フェーズ）
1. ユーザー検索機能
2. スレッドの一括管理機能
3. ダッシュボードの統計情報
4. 管理者アクションログ

## 技術的な事前準備
- [ ] WebSocketの導入（リアルタイム機能用）
- [ ] グラフライブラリの選定
- [ ] バックアップシステムの設計
- [ ] ログ管理システムの設計 

# エラー修正タスク

## 1. バックエンドルーティングの修正

### 問題の状況
- リクエストパスの不一致
- バックエンドで`/admin/users`としてリクエストが届いていた
- 正しいパスは`/api/admin/users`であるべき

### 修正内容
- `backend/src/app.js`のルーティング設定を変更
```javascript
// 変更前
app.use('/api/admin', adminRoutes);

// 変更後
app.use('/admin', adminRoutes);
```

### 修正の効果
- バックエンドのルーティングが`/admin/users`に正しくマッチするようになった
- リクエストのパスが一致し、ルーティングが正常に機能するようになった

### 現在発生している問題
- 認証エラー
```
トークンが存在しません
authenticateToken ミドルウェアエラー:
```

### 問題の原因
- フロントエンドから認証トークンが送信されていない
- `Authorization`ヘッダーが`undefined`

### 影響
- ユーザー一覧の取得が失敗
- 認証ミドルウェアでリクエストが拒否される

### 次のステップ
1. フロントエンドでの認証トークンの保存状態を確認
2. フロントエンドからのAPIリクエスト時のヘッダー設定を修正
3. 認証トークンの有効期限を確認

### 技術的な詳細

#### バックエンドのルーティング構造
```
/admin
  ├── /users (GET) - ユーザー一覧取得
  ├── /users/:id (GET) - ユーザー詳細取得
  ├── /users/:id/approve (POST) - ユーザー承認
  └── /dashboard (GET) - ダッシュボード情報取得
```

#### 認証ミドルウェアの動作
1. リクエストヘッダーから`Authorization`を取得
2. トークンの存在確認
3. トークンの検証
4. ユーザー情報の取得
5. 管理者権限の確認

### 注意点

#### セキュリティ
- 認証トークンの適切な管理が必要
- トークンの有効期限の管理
- セキュアなトークン保存方法の確保

#### パフォーマンス
- 認証チェックによるオーバーヘッド
- トークン検証の効率化

#### 保守性
- ルーティング設定の一元管理
- 認証ロジックの分離
- エラーハンドリングの統一 

## 2. 最終ログイン日時の実装

### 実装内容
- [x] データベースマイグレーション
  - `Users`テーブルに`lastLoginAt`カラムを追加
  - マイグレーションファイル: `20250404094007-add-last-login-at-to-users.js`
- [x] Userモデルの更新
  - `lastLoginAt`フィールドを追加
- [x] ログイン処理の更新
  - ログイン成功時に`lastLoginAt`を更新
- [x] ユーザー一覧取得の更新
  - `lastLoginAt`を取得して表示

### 実装の効果
- ユーザーの最終ログイン日時が記録されるようになった
- ユーザー一覧で最終ログイン日時が表示されるようになった

### 注意点
- 既存のカラムを変更せず、新規カラムのみを追加
- 不要なカラムの参照を避ける
- エラーハンドリングの実装を維持

## 3. フロントエンド認証トークンの修正

### 修正内容
- `frontend/public/js/admin/users.js`の`loadUsers`関数を修正
```javascript
// 変更前
const response = await fetch(`/api/admin/users?page=${currentPage}&${new URLSearchParams(currentFilters)}`);

// 変更後
const token = localStorage.getItem('token');
const response = await fetch(url, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

### 修正の効果
- 認証トークンが正しく送信されるようになった
- トークンの存在確認が可能になった
- デバッグ情報が増え、問題の特定が容易になった

### 確認結果
1. バックエンドのログ
   - 認証トークンが正しく送信されている
   - `Authorization`ヘッダーに`Bearer`トークンが含まれている
   - トークンの形式が正しい

2. 認証プロセスの動作
   - トークンの検証が正常に動作
   - ユーザー情報の取得が成功
   - 管理者権限の確認が正常

3. フロントエンドの動作
   - サーバーが正常に起動
   - 非推奨APIの警告は無視可能

### 現在の状況
- バックエンドのルーティング修正は成功
- 認証トークンの送信も正常に動作
- 認証プロセスも正しく機能

### 次のステップ
1. ユーザー一覧取得の処理の確認
   - データベースクエリのログ確認
   - レスポンスのログ確認
2. フロントエンドでのデータ表示確認
3. エラーハンドリングの確認 

### 新しいログ分析とエラー情報

#### 1. バックエンドのログ分析
1. 認証プロセス
   - トークンが正しく送信され、検証に成功
   - ユーザーは`superuser`権限を持ち、承認済み
   - `isAdmin`ミドルウェアまで正常に通過

2. リクエスト情報
   - メソッド: `GET`
   - URL: `/admin/users?page=1&keyword=&status=&documentStatus=`
   - ヘッダーに認証トークンが正しく含まれている

#### 2. フロントエンドのログ分析
1. リクエスト情報
   - トークンが存在することを確認
   - URL: `/api/admin/users?page=1&keyword=&status=&documentStatus=`
   - フィルター: 空の状態（`keyword`, `status`, `documentStatus`が空）

2. レスポンス情報
   - ステータス: 200 (OK)
   - レスポンスは成功（`success: true`）
   - データが含まれていることを確認

#### 3. エラー分析
1. エラーの種類: `TypeError: users is undefined`
2. エラーの発生箇所:
   - ファイル: `users.js`
   - 行番号: 108
   - 関数: `renderUsers`

3. エラーの原因
   - レスポンスデータの構造が想定と異なる
   - `data`オブジェクト内の`users`プロパティが存在しない

#### 4. 修正が必要な点
1. レスポンスデータの構造確認
   - バックエンドからのレスポンス形式を確認
   - フロントエンドのデータ処理部分の修正

2. エラーハンドリングの改善
   - `users`が未定義の場合の処理を追加
   - データ構造の検証を強化

#### 5. 次のステップ
1. バックエンドのレスポンス形式を確認
2. フロントエンドの`renderUsers`関数を修正
3. エラーハンドリングの追加

### デバッグ結果の分析

#### 1. 正常に動作している部分
1. バックエンド
   - 認証トークンの検証が成功
   - ユーザー権限（superuser）の確認が成功
   - データベースからユーザー一覧の取得が成功（5件のデータ）
   - レスポンスデータの構造が正しい

2. フロントエンド（成功部分）
   - トークンの存在確認が成功
   - APIリクエストが成功（status: 200）
   - データの取得が成功
   - レスポンスデータの構造が正しい（users, total, totalPages, currentPage）

#### 2. 新たに発見された問題点
1. 関数未定義エラー
   - `updatePagination`関数が未定義
   - `showError`関数が未定義

2. エラーの発生箇所
   - `loadUsers`関数内（97行目）でページネーション更新エラー
   - `loadUsers`関数内（104行目）でエラー表示機能のエラー

#### 3. 修正優先順位
1. 必須機能の実装
   - エラー表示機能（`showError`関数）の実装
   - ページネーション更新（`updatePagination`関数）の実装

2. UI/UX改善
   - エラーメッセージの表示方法の検討
   - ページネーションのデザイン統一

3. エラーハンドリングの強化
   - エラー発生時のユーザーへのフィードバック改善
   - エラーログの詳細化

#### 4. 次のステップ
1. フロントエンド機能の確認
   - 既存の`renderUsers`関数の動作確認
   - ページネーション関連の既存コード確認
   - エラー表示関連の既存コード確認

2. 実装方針の決定
   - 必要な関数の実装方法の検討
   - エラー表示のUI設計
   - ページネーションのUI設計

3. テスト計画
   - 実装後の動作確認項目
   - エラーケースのテストシナリオ

### ユーザー一覧機能の実装状況調査

#### 1. データベースとモデルの実装状況
1. Userモデルの必要フィールド
   - `status`: 実装済み
   - `documentStatus`: 実装済み
   - `lastLoginAt`: 存在確認必要
   - `createdAt`: 実装済み

#### 2. バックエンド実装状況
1. ユーザー一覧取得（`controllers/admin/users.js`）
   ```javascript
   const { count, rows: users } = await User.findAndCountAll({
     where,
     limit,
     offset,
     order: [['createdAt', 'DESC']]
   });
   ```
   - 基本的なユーザー情報取得は実装済み
   - `lastLoginAt`が取得対象に含まれていない

2. ログイン処理（`controllers/auth.js`）
   - ログイン処理自体は実装済み
   - `lastLoginAt`の更新処理が未実装

#### 3. フロントエンド実装状況
1. 表示機能
   - ユーザー一覧テーブルの実装済み
   - ステータスバッジの実装済み
   - 書類状態バッジの実装済み
   - 日付フォーマット関数の実装済み

2. バッジ表示の実装
   - ステータスバッジ
     ```javascript
     pending: '<span class="badge bg-warning">承認待ち</span>'
     approved: '<span class="badge bg-success">承認済み</span>'
     suspended: '<span class="badge bg-danger">停止中</span>'
     ```
   - 書類状態バッジ
     ```javascript
     not_submitted: '<span class="badge bg-secondary">未提出</span>'
     submitted: '<span class="badge bg-info">提出済み</span>'
     verified: '<span class="badge bg-success">確認済み</span>'
     ```

#### 4. 未実装・問題点
1. バックエンド
   - `lastLoginAt`の更新処理が未実装
   - ユーザー一覧取得時に`lastLoginAt`が含まれていない

2. データ取得状況
   - ステータス: 正常に取得可能
   - 書類状態: 正常に取得可能
   - 最終ログイン: 取得できていない

#### 5. 修正必要事項（優先順位順）
1. データベース確認
   - `lastLoginAt`カラムの存在確認
   - 必要に応じてマイグレーション作成

2. バックエンド修正
   - ユーザー一覧取得APIに`lastLoginAt`を追加
   - ログイン時の`lastLoginAt`更新処理の実装

3. 動作確認
   - ログイン時の`lastLoginAt`更新確認
   - ユーザー一覧での表示確認

# 書類提出・確認機能の実装タスク

## 1. データベース設計と実装
- [ ] ユーザーテーブルの拡張
  - `documentStatus`フィールドの追加（未提出/提出済/承認済/拒否）
  - `documentSubmittedAt`（提出日時）フィールドの追加
  - `documentVerifiedAt`（確認日時）フィールドの追加
  - `documentVerifiedBy`（確認者ID）フィールドの追加
  - `documentRejectReason`（拒否理由）フィールドの追加
- [ ] 書類ファイル管理テーブルの作成（必要に応じて）
  - ユーザーID、ファイルパス、アップロード日時などのフィールド
- [ ] マイグレーションファイルの作成
- [ ] データベースのアップデート

## 2. バックエンドAPI実装
- [ ] 書類アップロード機能
  - マルチパートフォームデータの処理
  - ファイルサイズ・タイプの検証
  - ファイルの保存処理
  - ユーザー情報の更新
- [ ] 書類確認・承認API
  - 書類の承認処理
  - 書類の拒否処理（理由の記録）
  - 書類ステータスの更新
- [ ] 書類情報取得API
  - ユーザーの書類ステータス取得
  - 書類画像の取得処理

## 3. フロントエンド実装
### 3.1 ユーザーマイページ
- [ ] 書類アップロード機能
  - ファイルアップロードフォーム
  - プレビュー表示
  - 進捗表示
  - エラー処理
- [ ] 書類ステータス表示
  - 現在の状態表示
  - 拒否理由の表示（該当する場合）
  - 再提出機能

### 3.2 管理者画面
- [ ] 承認待ちユーザー画面の拡張
  - 書類状態列の追加
  - 書類確認ボタンの追加
  - 書類プレビュー機能
- [ ] 書類承認/拒否機能
  - 承認ボタン
  - 拒否理由入力フォーム
  - 拒否ボタン

## 4. セキュリティ対策
- [ ] ファイルアップロードのセキュリティ
  - ファイルタイプの制限（画像のみ許可）
  - ファイルサイズの制限（最大5MB程度）
  - ファイル名のサニタイズ
- [ ] 個人情報保護対策
  - アップロードファイルへのアクセス制限
  - 書類データの暗号化（必要に応じて）
  - アクセスログの記録

## 5. テストとデバッグ
- [ ] ファイルアップロードのテスト
  - 正常系テスト（適切なファイル）
  - 異常系テスト（サイズ超過、不正なファイルタイプ）
- [ ] 承認・拒否機能のテスト
  - ステータス更新の確認
  - 通知機能の確認

## 6. UI/UX改善
- [ ] 直感的なアップロードインターフェース
  - ドラッグ＆ドロップ対応
  - プログレスバーの実装
- [ ] ステータス表示の改善
  - 視覚的にわかりやすいアイコン
  - 色分けによる状態表示

## 優先実装事項
1. データベース設計と拡張
2. バックエンドAPI（書類アップロード、ステータス管理）
3. マイページでの書類アップロード機能
4. 管理者画面での書類確認・承認機能